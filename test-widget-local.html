<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Test - Local (with localStorage)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
        }
        .test-steps {
            background: #f5f5f5;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .test-steps ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .test-steps li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <h1>Widget Test - Local (with localStorage)</h1>
    
    <div class="info">
        <h3>üìã Testing localStorage Persistence</h3>
        <p><strong>This test uses the LOCAL widget.js file</strong> (from your project folder)</p>
        <p>This allows you to test localStorage changes immediately without waiting for Vercel deployment.</p>
    </div>
    
    <div class="test-steps">
        <h3>üß™ Test Steps:</h3>
        <ol>
            <li><strong>Open the widget</strong> (click the chat button)</li>
            <li><strong>Send 2-3 messages</strong> to the widget</li>
            <li><strong>Refresh this page</strong> (F5 or Ctrl+R)</li>
            <li><strong>Open the widget again</strong></li>
            <li><strong>‚úÖ Expected:</strong> Your previous messages should be restored!</li>
        </ol>
    </div>
    
    <div class="info">
        <h3>üîç Debug Info:</h3>
        <p>Open browser DevTools (F12) ‚Üí Console tab to see widget logs</p>
        <p>Open DevTools ‚Üí Application tab ‚Üí Local Storage to see stored messages</p>
        <p>Storage key format: <code>ask_abilitix_widget_chat_{tenant}_{sessionId}</code></p>
        <p>Example: <code>ask_abilitix_widget_chat_abilitix-pilot_widget-1234567890-abc123</code></p>
        <p><strong>Note:</strong> Each browser tab/window gets a unique sessionId, so conversations are isolated per session.</p>
    </div>
    
    <!-- Widget embed (LOCAL - uses widget.js from public folder) -->
    <!-- Note: Make sure you're running the server from project root: python -m http.server 8000 -->
    <script src="public/widget.js" data-tenant="abilitix-pilot" data-widget-key="wid_lOLMLeoo9rUrySS4AD2hp7qIOGjuVO90"></script>
    
    <script>
        // Log localStorage activity
        const originalSetItem = localStorage.setItem;
        const originalGetItem = localStorage.getItem;
        
        localStorage.setItem = function(key, value) {
            if (key.includes('widget_chat')) {
                console.log('üíæ localStorage SET:', key, JSON.parse(value));
            }
            return originalSetItem.apply(this, arguments);
        };
        
        localStorage.getItem = function(key) {
            if (key.includes('widget_chat')) {
                const value = originalGetItem.apply(this, arguments);
                if (value) {
                    console.log('üìñ localStorage GET:', key, JSON.parse(value));
                }
            }
            return originalGetItem.apply(this, arguments);
        };
        
        // Check if messages are already stored (check for any session key)
        window.addEventListener('load', function() {
            setTimeout(() => {
                // Find all widget chat keys (they include sessionId)
                const widgetKeys = Object.keys(localStorage).filter(key => 
                    key.startsWith('ask_abilitix_widget_chat_abilitix-pilot_')
                );
                
                if (widgetKeys.length > 0) {
                    console.log(`‚úÖ Found ${widgetKeys.length} stored conversation(s):`);
                    widgetKeys.forEach(key => {
                        const stored = localStorage.getItem(key);
                        if (stored) {
                            const parsed = JSON.parse(stored);
                            const sessionId = key.split('_').pop();
                            console.log(`  - Session ${sessionId}: ${parsed.messages.length} messages`);
                        }
                    });
                } else {
                    console.log('‚ÑπÔ∏è No stored messages found (this is normal for first load)');
                }
            }, 1000);
        });
    </script>
</body>
</html>

